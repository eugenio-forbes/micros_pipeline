#!/bin/bash

# This template is designed to be loaded by micros_pipeline code to modify
# the directory containing the channels of a single macro-micro depth electrode (bank)

# If you want to change the way combinato runs e.g. changing parameters,
# Make a copy of combinato folder in your work folder and change path below to it.

#Load anaconda and source conda.sh file so that conda commands can be executed here
module load python/3.6.4-anaconda
source /cm/shared/apps/python/3.6.4-anaconda/etc/profile.d/conda.sh
export PATH="${PATH}:/path/to/micros_pipeline/pipeline/base_code/combinato"
export PYTHONPATH="${PYTHONPATH}:/path/to/micros_pipeline/pipeline/base_code/combinato"


#Check if combinato conda environment exists from list and activate it
if $(conda env list | grep -q "combinato")
then
    conda activate combinato
else                          #If not then install dependencies from .yml and add paths to .bashrc

    conda env create -f /path/to/micros_pipeline/pipeline/base_code/combinato.yml
    echo 'export PATH="${PATH}:/path/to/micros_pipeline/pipeline/base_code/combinato/"' >> ~/.bashrc
    echo 'export PYTHONPATH="${PYTHONPATH}:/path/to/micros_pipeline/pipeline/base_code/combinato/"' >> ~/.bashrc
    echo 'source /cm/shared/apps/python/3.6.4-anaconda/etc/profile.d/conda.sh' >> ~/.bashrc
    conda activate combinato
fi

dirPath="%s"
# Directory to be edited by Matlab using sprintf(this_whole_text,path_to_combinato_folder) function.
# Combinato commands will execute in this directory, so change directory to this
cd $dirPath

# Prepare for sorting negative spikes
echo 'Preparing sorting of spikes...\n'
css-prepare-sorting --neg --jobs do_sort.txt --label %s
css-prepare-sorting --jobs do_sort.txt --label %s

# Run clustering of negative spikes
echo 'Clustering negative spikes...\n'
css-cluster --jobs sort_neg_%s.txt
css-cluster --jobs sort_pos_%s.txt

# Combine clustering results
echo 'Combining results...\n'
css-combine --jobs sort_neg_%s.txt
css-combine --jobs sort_pos_%s.txt

# This will return a status of 0 to matlab function once file is executed and done
exit 0
