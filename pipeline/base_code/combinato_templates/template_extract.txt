#!/bin/bash

# This is part 1 of 2 of the combinato clustering process. Second part in template_cluster.sh

# This template is designed to be modified by micros_pipeline code using
# sprintf formula, to change input directory to be specific Bank that is
# being looped through.

# Since system commands in matlab run in new shells each time, the
# conda environment needs to be activated, and the paths added

# Load anaconda and source conda.sh file so that conda commands can be executed here
module load python/3.6.4-anaconda
source /cm/shared/apps/python/3.6.4-anaconda/etc/profile.d/conda.sh
export PATH="${PATH}:/path/to/micros_pipeline/pipeline/base_code/combinato"
export PYTHONPATH="${PYTHONPATH}:/path/to/micros_pipeline/pipeline/base_code/combinato"


# Check if combinato conda environment exists from list and activate it
if $(conda env list | grep -q "combinato")
then
    conda activate combinato
else                          #If not then install dependencies from .yml and add paths to .bashrc

    conda env create -f /path/to/micros_pipeline/pipeline/base_code/combinato.yml
    echo 'export PATH="${PATH}:/path/to/micros_pipeline/pipeline/base_code/combinato/"' >> ~/.bashrc
    echo 'export PYTHONPATH="${PYTHONPATH}:/path/to/micros_pipeline/pipeline/base_code/combinato/"' >> ~/.bashrc
    echo 'source /cm/shared/apps/python/3.6.4-anaconda/etc/profile.d/conda.sh' >> ~/.bashrc
    conda activate combinato
fi

dirPath="%s"
# Directory to be edited by Matlab using sprintf(this_whole_text,path_to_combinato_folder) function.
# Combinato commands will execute in this directory, so change directory to this
cd $dirPath

# Run css-extract command for every channels .hdf5 file in the folder
for chan in *.hdf5; do
    echo 'Extracting spikes...\n'   
	css-extract --files "${chan}" --h5
done

# Find concurrent spikes and mask artifacts for all channels in folder.	
echo 'Finding concurrent spikes...\n'
css-find-concurrent --concurrent-file concurrent_times.h5
echo 'Masking artifactual spikes...\n'
css-mask-artifacts

# List sorting jobs for all channels
ls */*.h5 > do_sort.txt

# Plot extracted spikes
echo 'Plotting extracted spikes...\n'
css-plot-extracted

# This will return a status of 0 to matlab function once file is executed and done
exit 0
